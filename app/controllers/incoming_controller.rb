class IncomingController < ApplicationController
  include HTTParty

  # http://stackoverflow.com/questions/1177863/how-do-i-ignore-the-authenticity-token-for-specific-actions-in-rails
  skip_before_action :verify_authenticity_token, only: [:create]

  def create
    puts "\nINCOMING PARAMS:\n#{params}"
    user = User.find_by_email(params['sender'])
    return head 200 unless user

    url = params['body-plain'].strip
    topic = Topic.find_by(title: 'From Email')
    topic = Topic.create(title: 'From Email', user: user) if topic.nil?

    b = create_bookmark(url, topic, user)

    return_code(b)
  end

  def create_bookmark(url, topic, user)
    b = Bookmark.new(url: url, topic: topic, user: user)

    b unless b.invalid?
  end

  def return_code(bookmark)
    head 400 if bookmark.nil?
    if b.save
      head 201
    else
      head 422
    end
  end
end


# {"recipient"=>"bookmark@blocmark.devmichael.com", "sender"=>"mdavis93@hotmail.com", "subject"=>"Cortiva Institute", "from"=>"Michael Davis <mdavis93@hotmail.com>", "X-Mailgun-Incoming"=>"Yes", "X-Envelope-From"=>"<mdavis93@hotmail.com>", "Received"=>"from CY4PR02MB3288.namprd02.prod.outlook.com ([10.165.88.159]) by CY4PR02MB3288.namprd02.prod.outlook.com ([10.165.88.159]) with mapi id 15.20.0323.018; Fri, 22 Dec 2017 23:15:44 +0000", "Dkim-Signature"=>"v=1; a=rsa-sha256; c=relaxed/relaxed; d=hotmail.com; s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version; bh=xAzuswmGNTu130413G1wTJleqCdnOCbQb5bir2ncCMc=; b=VWz0dnFL5HsVAr/qGORZpyVN5/uNiCEUznR81LVOvQs3JAwSyBdC7MNactnGHzg0QBbQrfPQ3yiBT5CbYzTyBVVzSJuwMq9ZdTpKhI8vkeNzuA0es8rElZ/qZyxRh9Ad3dj8ONosWkai+W4+F4HtcghjrabHQ8yJ+fzTVV4PTLBMpGIFfqtE+CpPLy3HoTcKilpB6twxWHPcFH5uE6uB3NS4kILUQHRfdmBsbcooqdZfmqv4rcsSnE+2iOfwVZjBeBmOt690qybyLLz/ak3pLgoHAYdvlhlNJVt4d0+PA0E7J0d+Av97yDuA8kTh5wIx45oOFebBPaE1qGOL8wyz/Q==", "From"=>"Michael Davis <mdavis93@hotmail.com>", "To"=>"\"bookmark@blocmark.devmichael.com\" <bookmark@blocmark.devmichael.com>", "Subject"=>"Cortiva Institute", "Thread-Topic"=>"Cortiva Institute", "Thread-Index"=>"AQHTe3rKv2dk7mQDxkiuEd0880tjHQ==", "Date"=>"Fri, 22 Dec 2017 23:15:44 +0000", "Message-Id"=>"<CY4PR02MB328831EE09E0EA35406C3CB5C1020@CY4PR02MB3288.namprd02.prod.outlook.com>", "Accept-Language"=>"en-US", "Content-Language"=>"en-US", "X-Ms-Has-Attach"=>"", "X-Ms-Tnef-Correlator"=>"", "X-Incomingtopheadermarker"=>"OriginalChecksum:827924DCC9A58C7096E4913EC08F734BB5BEC6C64A06565880CA4FA23B6619CD;UpperCasedChecksum:B19E7AE7A2497D3A249F1115BA64EE512F4EDA5F149C0680910A4D35F5A6BB4F;SizeAsReceived:6871;Count:44", "X-Ms-Exchange-Messagesentrepresentingtype"=>"1", "X-Tmn"=>"[cg+fO0c4gjXpu6+GNcsBSokesApgnokZbQebyB8tlckHXwrmlN1KshbV6nHompqD]", "X-Ms-Publictraffictype"=>"Email", "X-Microsoft-Exchange-Diagnostics"=>"1;BY2NAM03HT212;6:ewt5RNO/pkCwKnRs8tIVfvDE0+Idaayg7GBldXM6z+A6byA8hybDQAOQrUlFt8MYfERzavffSdO37JTDzvW4WBSEh0QGlLv3P3hoRaUwUGw3pWq+0PkUhrCNXgbOZ/+tOvh/03OgpAH7oAZXbxFEWOCJ7pofNI9vOLx3o3SlMkdGZYjWZp3ZkpKHfOTVYz/leKaA1j1m6HhFb5mXaiD2oFBEAQe3S1eoCBEgF0qhBXoPUj9w1PvxEhYGXn7ZcpfLO+wdIwWRl6M1INgd8t2isCbgJxo3diRTqdgf8X/U2U1woHU73SRjnWnFPLRL7yb5pannj1in7NW3q3JBgQYsJMEORzf20fzASz9v/4nd9Bo=;5:XUhakURqaAHU1bR6OqxGVVGaiurNo9GS+4246cgzPKfPKW9dXjJfQOBBKuzkRQIMvNDqFdk5c6e5w2hqgttPwhAw0j07GmCK8AJiZBugoGKNtRcYVNJ6MxgkFqdoyjGF0UE8pgt708HaJCkK47Ika80SdGbrWZcDlEu12hdmwik=;24:Nt2bPjgnU+3u8t183k/PFKLTJuhkSn2AXSBB6VsQ6SISxP66+xpgwSllCoEWMtTTZJUNB7o26ryuco1OCDd0cnqdySKRMBrjpmwyLKwSS8Q=;7:mlsOZ8CgmvlHl+nwkbi6Hn0lTukL+XQ3J2ZcRu3XbchCVXHGQYNzcsyRW8qeosGKvIYdKn8QBqnhpzjsJJ/KxBH0IGqLM27nhtg60zwEGbySd8KjI5vj8TM1n1IKVwhcGr6e4MDGiXIT4XGYACkfCm2/tcXSjWUL6VnR3KblZtsWEeCYu05Q8zbxxfg0+p11VV+/uScQAak9zAoTzEzyP6QNPZ/ViQUdwEQ7tJUKExxX4pOjAFX+QusiawBAOoD7", "X-Incomingheadercount"=>"44", "X-Eopattributedmessage"=>"0", "X-Microsoft-Antispam"=>"UriScan:;BCL:0;PCL:0;RULEID:(7020020)(201702061074)(5061506573)(5061507331)(1603103135)(2017031320274)(2017031324274)(2017031323274)(2017031322404)(1603101448)(1601125374)(1701031045);SRVR:BY2NAM03HT212;", "X-Ms-Traffictypediagnostic"=>"BY2NAM03HT212:", "X-Ms-Office365-Filtering-Correlation-Id"=>"91caeca2-139c-42eb-d96e-08d54991ed05", "X-Exchange-Antispam-Report-Cfa-Test"=>"BCL:0;PCL:0;RULEID:(444000031);SRVR:BY2NAM03HT212;BCL:0;PCL:0;RULEID:(100000803101)(100110400095);SRVR:BY2NAM03HT212;", "X-Forefront-Prvs"=>"05299D545B", "X-Forefront-Antispam-Report"=>"SFV:NSPM;SFS:(7070007)(98901004);DIR:OUT;SFP:1901;SCL:1;SRVR:BY2NAM03HT212;H:CY4PR02MB3288.namprd02.prod.outlook.com;FPR:;SPF:None;LANG:;", "Spamdiagnosticoutput"=>"1:99", "Spamdiagnosticmetadata"=>"NSPM", "Content-Type"=>"multipart/alternative; boundary=\"_000_CY4PR02MB328831EE09E0EA35406C3CB5C1020CY4PR02MB3288namp_\"", "Mime-Version"=>"1.0", "X-Originatororg"=>"hotmail.com", "X-Ms-Exchange-Crosstenant-Network-Message-Id"=>"91caeca2-139c-42eb-d96e-08d54991ed05", "X-Ms-Exchange-Crosstenant-Originalarrivaltime"=>"22 Dec 2017 23:15:44.2368 (UTC)", "X-Ms-Exchange-Crosstenant-Fromentityheader"=>"Internet", "X-Ms-Exchange-Crosstenant-Id"=>"84df9e7f-e9f6-40af-b435-aaaaaaaaaaaa", "X-Ms-Exchange-Transport-Crosstenantheadersstamped"=>"BY2NAM03HT212", "message-headers"=>"[[\"X-Mailgun-Incoming\", \"Yes\"], [\"X-Envelope-From\", \"<mdavis93@hotmail.com>\"], [\"Received\", \"from NAM03-CO1-obe.outbound.protection.outlook.com (mail-oln040092007011.outbound.protection.outlook.com [40.92.7.11]) by mxa.mailgun.org with ESMTP id 5a3d9221.7f6e72a0d9d0-smtp-in-n02; Fri, 22 Dec 2017 23:15:45 -0000 (UTC)\"], [\"Dkim-Signature\", \"v=1; a=rsa-sha256; c=relaxed/relaxed; d=hotmail.com; s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version; bh=xAzuswmGNTu130413G1wTJleqCdnOCbQb5bir2ncCMc=; b=VWz0dnFL5HsVAr/qGORZpyVN5/uNiCEUznR81LVOvQs3JAwSyBdC7MNactnGHzg0QBbQrfPQ3yiBT5CbYzTyBVVzSJuwMq9ZdTpKhI8vkeNzuA0es8rElZ/qZyxRh9Ad3dj8ONosWkai+W4+F4HtcghjrabHQ8yJ+fzTVV4PTLBMpGIFfqtE+CpPLy3HoTcKilpB6twxWHPcFH5uE6uB3NS4kILUQHRfdmBsbcooqdZfmqv4rcsSnE+2iOfwVZjBeBmOt690qybyLLz/ak3pLgoHAYdvlhlNJVt4d0+PA0E7J0d+Av97yDuA8kTh5wIx45oOFebBPaE1qGOL8wyz/Q==\"], [\"Received\", \"from BY2NAM03FT028.eop-NAM03.prod.protection.outlook.com (10.152.84.57) by BY2NAM03HT212.eop-NAM03.prod.protection.outlook.com (10.152.85.250) with Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384_P384) id 15.20.345.12; Fri, 22 Dec 2017 23:15:44 +0000\"], [\"Received\", \"from CY4PR02MB3288.namprd02.prod.outlook.com (10.152.84.56) by BY2NAM03FT028.mail.protection.outlook.com (10.152.84.238) with Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256_P256) id 15.20.345.12 via Frontend Transport; Fri, 22 Dec 2017 23:15:44 +0000\"], [\"Received\", \"from CY4PR02MB3288.namprd02.prod.outlook.com ([10.165.88.159]) by CY4PR02MB3288.namprd02.prod.outlook.com ([10.165.88.159]) with mapi id 15.20.0323.018; Fri, 22 Dec 2017 23:15:44 +0000\"], [\"From\", \"Michael Davis <mdavis93@hotmail.com>\"], [\"To\", \"\\\"bookmark@blocmark.devmichael.com\\\" <bookmark@blocmark.devmichael.com>\"], [\"Subject\", \"Cortiva Institute\"], [\"Thread-Topic\", \"Cortiva Institute\"], [\"Thread-Index\", \"AQHTe3rKv2dk7mQDxkiuEd0880tjHQ==\"], [\"Date\", \"Fri, 22 Dec 2017 23:15:44 +0000\"], [\"Message-Id\", \"<CY4PR02MB328831EE09E0EA35406C3CB5C1020@CY4PR02MB3288.namprd02.prod.outlook.com>\"], [\"Accept-Language\", \"en-US\"], [\"Content-Language\", \"en-US\"], [\"X-Ms-Has-Attach\", \"\"], [\"X-Ms-Tnef-Correlator\", \"\"], [\"X-Incomingtopheadermarker\", \"OriginalChecksum:827924DCC9A58C7096E4913EC08F734BB5BEC6C64A06565880CA4FA23B6619CD;UpperCasedChecksum:B19E7AE7A2497D3A249F1115BA64EE512F4EDA5F149C0680910A4D35F5A6BB4F;SizeAsReceived:6871;Count:44\"], [\"X-Ms-Exchange-Messagesentrepresentingtype\", \"1\"], [\"X-Tmn\", \"[cg+fO0c4gjXpu6+GNcsBSokesApgnokZbQebyB8tlckHXwrmlN1KshbV6nHompqD]\"], [\"X-Ms-Publictraffictype\", \"Email\"], [\"X-Microsoft-Exchange-Diagnostics\", \"1;BY2NAM03HT212;6:ewt5RNO/pkCwKnRs8tIVfvDE0+Idaayg7GBldXM6z+A6byA8hybDQAOQrUlFt8MYfERzavffSdO37JTDzvW4WBSEh0QGlLv3P3hoRaUwUGw3pWq+0PkUhrCNXgbOZ/+tOvh/03OgpAH7oAZXbxFEWOCJ7pofNI9vOLx3o3SlMkdGZYjWZp3ZkpKHfOTVYz/leKaA1j1m6HhFb5mXaiD2oFBEAQe3S1eoCBEgF0qhBXoPUj9w1PvxEhYGXn7ZcpfLO+wdIwWRl6M1INgd8t2isCbgJxo3diRTqdgf8X/U2U1woHU73SRjnWnFPLRL7yb5pannj1in7NW3q3JBgQYsJMEORzf20fzASz9v/4nd9Bo=;5:XUhakURqaAHU1bR6OqxGVVGaiurNo9GS+4246cgzPKfPKW9dXjJfQOBBKuzkRQIMvNDqFdk5c6e5w2hqgttPwhAw0j07GmCK8AJiZBugoGKNtRcYVNJ6MxgkFqdoyjGF0UE8pgt708HaJCkK47Ika80SdGbrWZcDlEu12hdmwik=;24:Nt2bPjgnU+3u8t183k/PFKLTJuhkSn2AXSBB6VsQ6SISxP66+xpgwSllCoEWMtTTZJUNB7o26ryuco1OCDd0cnqdySKRMBrjpmwyLKwSS8Q=;7:mlsOZ8CgmvlHl+nwkbi6Hn0lTukL+XQ3J2ZcRu3XbchCVXHGQYNzcsyRW8qeosGKvIYdKn8QBqnhpzjsJJ/KxBH0IGqLM27nhtg60zwEGbySd8KjI5vj8TM1n1IKVwhcGr6e4MDGiXIT4XGYACkfCm2/tcXSjWUL6VnR3KblZtsWEeCYu05Q8zbxxfg0+p11VV+/uScQAak9zAoTzEzyP6QNPZ/ViQUdwEQ7tJUKExxX4pOjAFX+QusiawBAOoD7\"], [\"X-Incomingheadercount\", \"44\"], [\"X-Eopattributedmessage\", \"0\"], [\"X-Microsoft-Antispam\", \"UriScan:;BCL:0;PCL:0;RULEID:(7020020)(201702061074)(5061506573)(5061507331)(1603103135)(2017031320274)(2017031324274)(2017031323274)(2017031322404)(1603101448)(1601125374)(1701031045);SRVR:BY2NAM03HT212;\"], [\"X-Ms-Traffictypediagnostic\", \"BY2NAM03HT212:\"], [\"X-Ms-Office365-Filtering-Correlation-Id\", \"91caeca2-139c-42eb-d96e-08d54991ed05\"], [\"X-Exchange-Antispam-Report-Cfa-Test\", \"BCL:0;PCL:0;RULEID:(444000031);SRVR:BY2NAM03HT212;BCL:0;PCL:0;RULEID:(100000803101)(100110400095);SRVR:BY2NAM03HT212;\"], [\"X-Forefront-Prvs\", \"05299D545B\"], [\"X-Forefront-Antispam-Report\", \"SFV:NSPM;SFS:(7070007
# )(98901004);DIR:OUT;SFP:1901;SCL:1;SRVR:BY2NAM03HT212;H:CY4PR02MB3288.namprd02.prod.outlook.com;FPR:;SPF:None;LANG:;\"], [\"Spamdiagnosticoutput\", \"1:99\"], [\"Spamdiagnosticmetadata\", \"NSPM\"], [\"Content-Type\", \"multipart/alternative; boundary=\\\"_000_CY4PR02MB328831EE09E0EA35406C3CB5C1020CY4PR02MB3288namp_\\\"\"], [\"Mime-Version\", \"1.0\"], [\"X-Originatororg\", \"hotmail.com\"], [\"X-Ms-Exchange-Crosstenant-Network-Message-Id\", \"91caeca2-139c-42eb-d96e-08d54991ed05\"], [\"X-Ms-Exchange-Crosstenant-Originalarrivaltime\", \"22 Dec 2017 23:15:44.2368 (UTC)\"], [\"X-Ms-Exchange-Crosstenant-Fromentityheader\", \"Internet\"], [\"X-Ms-Exchange-Crosstenant-Id\", \"84df9e7f-e9f6-40af-b435-aaaaaaaaaaaa\"], [\"X-Ms-Exchange-Transport-Crosstenantheadersstamped\", \"BY2NAM03HT212\"]]", "timestamp"=>"1513984545", "token"=>"16f22b7d4fa0809d9307bb8caf89513e3c86a35641bf3b0eae", "signature"=>"3ca7a79bec8250bf1fce684792dfc4ec642fc5e8277f9c11e7532baa39758be6", "body-plain"=>"http://www.cortiva.edu\r\n", "body-html"=>"<html>\r\n<head>\r\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=us-ascii\">\r\n</head>\r\n<body style=\"word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;\" class=\"\">\r\n<a href=\"http://www.cortiva.edu\" class=\"\">http://www.cortiva.edu</a>\r\n</body>\r\n</html>\r\n", "stripped-html"=>"<html>\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=us-ascii\">\n</head>\n<body style=\"word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;\" class=\"\">\n<a href=\"http://www.cortiva.edu\" class=\"\">http://www.cortiva.edu</a>\n</body>\n</html>\n", "stripped-text"=>"http://www.cortiva.edu", "stripped-signature"=>"", "controller"=>"incoming", "action"=>"create"}